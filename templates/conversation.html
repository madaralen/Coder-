{% extends "base.html" %}

{% block title %}Conversation {{ conversation.repo_full_name }} #{{ conversation.context_number }} - Coder Bot{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <nav class="text-sm text-gray-400 mb-2">
                <a href="/dashboard" class="hover:text-white">Dashboard</a>
                <span class="mx-2">/</span>
                <span>Conversation</span>
            </nav>
            <h2 class="text-2xl font-bold text-white">
                {{ conversation.repo_full_name }} 
                #{{ conversation.context_number }}
            </h2>
            <p class="text-gray-400">
                {{ conversation.context_type|title }} â€¢ 
                {{ conversation.status|title }} â€¢ 
                Created {{ conversation.created_at }}
            </p>
        </div>
        <div class="flex items-center space-x-4">
            <a href="https://github.com/{{ conversation.repo_full_name }}/{{ 'issues' if conversation.context_type == 'issue' else 'pull' }}/{{ conversation.context_number }}" 
               target="_blank" 
               class="inline-flex items-center px-4 py-2 border border-gray-600 rounded-md text-sm font-medium text-gray-300 bg-gray-700 hover:bg-gray-600">
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
                View on GitHub
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Main Chat -->
        <div class="lg:col-span-3">
            <div class="bg-gray-800 rounded-lg border border-gray-700 h-[600px] flex flex-col">
                <div class="px-6 py-4 border-b border-gray-700">
                    <h3 class="text-lg font-semibold text-white">Conversation</h3>
                </div>
                
                <div class="flex-1 overflow-y-auto scrollbar-thin p-6 space-y-4">
                    {% if messages %}
                        {% for message in messages %}
                        <div class="flex space-x-3 {{ 'justify-end' if message.role == 'assistant' else '' }}">
                            {% if message.role != 'assistant' %}
                            <!-- User message -->
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                                    {% if message.role == 'system' %}
                                        <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 2L2 7v10c0 5.55 3.84 10 9 11 1.09-.21 2.08-.64 2.92-1.21-5.16-.51-9.08-4.2-9.92-8.79H12V2z"/>
                                        </svg>
                                    {% else %}
                                        <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                        </svg>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="bg-gray-700 rounded-lg px-4 py-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <p class="text-sm font-medium text-white">
                                            {{ message.author or 'System' }}
                                        </p>
                                        <p class="text-xs text-gray-400">
                                            {{ message.created_at }}
                                        </p>
                                    </div>
                                    <div class="text-sm text-gray-200 whitespace-pre-wrap">{{ message.content }}</div>
                                    {% if message.github_event_type %}
                                    <div class="mt-2">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            {{ message.github_event_type }}
                                        </span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% else %}
                            <!-- Assistant message -->
                            <div class="flex-1 min-w-0">
                                <div class="bg-blue-600 rounded-lg px-4 py-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <p class="text-sm font-medium text-white">
                                            ðŸ¤– Coder Bot
                                        </p>
                                        <p class="text-xs text-blue-200">
                                            {{ message.created_at }}
                                        </p>
                                    </div>
                                    <div class="text-sm text-white whitespace-pre-wrap">{{ message.content }}</div>
                                </div>
                            </div>
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                                    <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                                    </svg>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-8">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                            <h3 class="mt-2 text-sm font-medium text-gray-300">No messages yet</h3>
                            <p class="mt-1 text-sm text-gray-400">The conversation will appear here once it starts.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Agent Actions -->
            <div class="bg-gray-800 rounded-lg border border-gray-700">
                <div class="px-4 py-3 border-b border-gray-700">
                    <h3 class="text-sm font-semibold text-white">Agent Actions</h3>
                </div>
                <div class="p-4">
                    {% if actions %}
                        <div class="space-y-3">
                            {% for action in actions %}
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0">
                                    {% if action.status == 'completed' %}
                                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                    {% elif action.status == 'failed' %}
                                        <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                                    {% else %}
                                        <div class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></div>
                                    {% endif %}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm text-white">{{ action.action_type.replace('_', ' ')|title }}</p>
                                    <p class="text-xs text-gray-400">{{ action.created_at }}</p>
                                    {% if action.error_message %}
                                    <p class="text-xs text-red-400">{{ action.error_message }}</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-sm text-gray-400">No actions yet</p>
                    {% endif %}
                </div>
            </div>

            <!-- Conversation Info -->
            <div class="bg-gray-800 rounded-lg border border-gray-700">
                <div class="px-4 py-3 border-b border-gray-700">
                    <h3 class="text-sm font-semibold text-white">Information</h3>
                </div>
                <div class="p-4 space-y-3">
                    <div>
                        <p class="text-xs text-gray-400">Repository</p>
                        <p class="text-sm text-white">{{ conversation.repo_full_name }}</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400">Type</p>
                        <p class="text-sm text-white">{{ conversation.context_type|title }}</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400">Number</p>
                        <p class="text-sm text-white">#{{ conversation.context_number }}</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400">Status</p>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                            {% if conversation.status == 'active' %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ conversation.status|title }}
                        </span>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400">Created</p>
                        <p class="text-sm text-white">{{ conversation.created_at }}</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-400">Last Updated</p>
                        <p class="text-sm text-white">{{ conversation.updated_at }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
